<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Web Chấm Lương — UI Xịn</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#4f46e5;
  --surface:#0b1220; --soft: rgba(255,255,255,0.03);
  --success:#10b981; --danger:#ef4444;
  --glass: rgba(255,255,255,0.03);
  --card-plain:#0b1220;
  --text:#e6eef8;
}
/* NGĂN TRÀN NGANG */
body {
  overflow-x: hidden; /* không cho scroll ngang */
}

/* MAIN: co nhỏ cột trái khi container nhỏ */
.main {
  display: grid;
  grid-template-columns: minmax(0, 420px) 1fr;
  gap: 18px;
  margin-top: 16px;
}

/* Canvas chart responsive */
canvas {
  max-width: 100% !important;
  height: auto !important;
}

/* Table wrapper giữ responsive */
.table-wrap {
  width: 100%;
  overflow-x: auto;
}

/* Cards responsive */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

/* Controls responsive */
.controls {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap; /* wrap khi màn hình nhỏ */
}

/* Form-row responsive */
.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
}

/* Đảm bảo các input/select không tràn */
.input, select, input[type="date"], input[type="number"], input[type="text"] {
  max-width: 100%;
  box-sizing: border-box;
}

/* Light theme overrides (added via .light-theme on body) */
body.light-theme{ --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --surface:#ffffff; --text:#071020; --glass: rgba(2,6,23,0.04); }

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,var(--bg), rgba(0,0,0,0.02)); color:var(--text); -webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:28px auto;padding:20px;border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); backdrop-filter: blur(6px);}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.brand{display:flex;gap:12px;align-items:center}
.logo{
  width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#06b6d4);
  display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px;box-shadow:0 6px 24px rgba(2,6,23,0.4);
}
.title{font-size:18px;font-weight:700}
.subtitle{font-size:13px;color:var(--muted)}

/* controls */
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.input, select{padding:10px 12px;border-radius:10px;border:1px solid var(--glass);background:transparent;color:var(--text);min-width:120px}
.input::placeholder{color:var(--muted)}
.btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
.btn-primary{background:linear-gradient(90deg,var(--accent),#06b6d4);color:white;box-shadow:0 8px 30px rgba(79,70,229,0.12)}
.btn-ghost{background:transparent;border:1px solid var(--glass);color:var(--text)}
.small{font-size:13px;color:var(--muted)}

/* cards */
.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
.card{padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--glass);box-shadow:0 8px 30px rgba(2,6,23,0.2)}
.card small{color:var(--muted)}
.card strong{display:block;font-size:20px;margin-top:6px}

/* layout */
.main{display:grid;grid-template-columns:420px 1fr;gap:18px;margin-top:16px}
@media(max-width:980px){ .main{grid-template-columns:1fr; } .cards{grid-template-columns:repeat(2,1fr)} }

/* left form */
.panel{background:var(--surface);padding:14px;border-radius:12px;border:1px solid var(--glass)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.form-field{margin-bottom:10px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input[type="date"], input[type="number"], input[type="text"], select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--glass);background:transparent;color:var(--text)}

/* table */
.table-wrap{margin-top:12px;border-radius:12px;overflow:auto;border:1px solid var(--glass);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
table{width:100%;border-collapse:collapse;font-size:14px}
thead th{position:sticky;top:0;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:12px;text-align:center;color:var(--muted);border-bottom:1px solid var(--glass)}
tbody td{padding:10px;text-align:center;border-bottom:1px solid var(--glass);color:var(--text)}
tbody tr:hover{background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))}

/* tags */
.tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
.tag-giao{background:rgba(99,102,241,0.12);color:#7c3aed}
.tag-bh{background:rgba(245,158,11,0.12);color:#b45309}

/* details modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:120;padding:18px}
.modal-card{width:100%;max-width:920px;background:var(--surface);border-radius:12px;padding:18px;border:1px solid var(--glass);box-shadow:0 20px 60px rgba(2,6,23,0.6);max-height:90vh;overflow:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.close{background:transparent;border:0;color:var(--muted);font-size:18px;cursor:pointer}

/* actions */
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* small helpers */
.kv{font-size:13px;color:var(--muted)}

/* footer */
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px;padding-bottom:30px}

/* fancy */
.fadein{animation:fadein .28s ease}
@keyframes fadein{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none}}

/* responsive small devices */
@media(max-width:640px){
  .controls{flex-direction:column;align-items:flex-start}
  .cards{grid-template-columns:1fr}
  .form-row{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">CL</div>
      <div>
        <div class="title">Web Chấm Lương — UI Xịn</div>
        <div class="subtitle">Offline • localStorage • Gộp theo ngày • Responsive</div>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="input" placeholder="Tìm theo ghi chú / ngày (yyyy-mm-dd)..." oninput="renderTable()" />
      <input id="filterMonth" class="input" type="month" onchange="renderTable()" />
      <select id="themeSel" class="input" onchange="toggleTheme(this.value)">
        <option value="dark">Giao diện: Tối</option>
        <option value="light">Giao diện: Sáng</option>
      </select>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="clearAll()">Xóa tất cả</button>
        <button class="btn btn-primary" onclick="exportCSV()">Xuất CSV</button>
        <button class="btn btn-primary" onclick="window.print()">In</button>
      </div>
    </div>
  </div>

  <div class="cards">
    <div class="card">
      <small>Tổng tiền (đang hiển thị)</small>
      <strong id="cardTongTien">0 VND</strong>
      <div class="kv" style="margin-top:8px">Tổng tiền tính theo hàm lương + phụ cấp</div>
    </div>
    <div class="card">
      <small>Tổng đơn giao</small>
      <strong id="cardGiao">0</strong>
      <div class="kv" style="margin-top:8px">Số lượng 'Đơn giao' đã nhập</div>
    </div>
    <div class="card">
      <small>Tổng đơn bảo hành</small>
      <strong id="cardBaoHanh">0</strong>
      <div class="kv" style="margin-top:8px">Số lượng 'Đơn bảo hành'</div>
    </div>
  </div>

  <div class="main">
    <!-- LEFT: FORM NHẬP -->
    <div class="panel fadein">
      <h3 style="margin:0 0 10px 0">Thêm phiếu — Nhập nhanh</h3>

      <div class="form-row">
        <div>
          <label>Ngày</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>Loại đơn</label>
          <select id="donLoai">
            <option>Đơn giao</option>
            <option>Đơn bảo hành</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Số bộ giao (30k/bộ)</label>
          <input id="deliver" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Giờ tăng ca (50k/giờ)</label>
          <input id="ot" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>KM di chuyển (1k/km)</label>
          <input id="km" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Số đơn trong ngày</label>
          <input id="soDon" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="form-field">
        <label>Ghi chú</label>
        <input id="ghiChu" type="text" placeholder="Nhập ghi chú (ví dụ: khu vực, ghi chú khách...)" />
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-primary" onclick="saveEntry()">Lưu</button>
        <button class="btn btn-ghost" onclick="resetForm()">Làm mới</button>
      </div>

      <div style="margin-top:12px;color:var(--muted);font-size:13px">
        Lưu trữ offline: <strong>localStorage key = chamLuong</strong>
      </div>
    </div>

    <!-- RIGHT: BẢNG + CHART -->
    <div>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="flex:1">
          <h3 style="margin:0 0 8px 0">Danh sách (gộp ngày)</h3>
          <div class="small">Nhấn "Chi tiết" để mở danh sách entry theo ngày và sửa/xóa từng dòng.</div>
        </div>
        <canvas id="chart" style="width:340px;height:120px;background:transparent;border-radius:8px;padding:6px"></canvas>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Ngày</th>
              <th>Loại</th>
              <th>Tổng đơn</th>
              <th>Tổng tiền</th>
              <th>Ghi chú (tổng)</th>
              <th>Chi tiết</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <div class="small">Tìm nhanh: nhập ngày hoặc từ khóa ghi chú → Enter để lọc.</div>
      </div>
    </div>
  </div>

  <div class="footer">© Web Chấm Lương — Offline. Nếu muốn tôi tách file CSS/JS riêng hoặc thêm tải xuống PDF, nói tôi biết.</div>
</div>

<!-- DETAILS / EDIT MODAL -->
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <h3 style="margin:0">Chi tiết ngày <span id="modalDate" style="color:var(--muted);font-weight:600"></span></h3>
        <div id="modalSummary" class="small" style="margin-top:6px;color:var(--muted)"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-ghost" onclick="closeModal()">Đóng</button>
      </div>
    </div>

    <div id="modalList"></div>

  </div>
</div>

<script>
/* =========================
   APP: Web Chấm Lương UI
   key: chamLuong
   ========================= */

const STORAGE_KEY = 'chamLuong';
let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
let editingIndex = null;

// Theme init
function toggleTheme(mode){
  if(mode === 'light') document.body.classList.add('light-theme');
  else document.body.classList.remove('light-theme');
}
document.getElementById('themeSel').value = 'dark';
toggleTheme('dark');

/* ---------- Core: tính tiền ---------- */
function calcMoney(entry){
  // entry: {deliver, ot, km, soDon}
  const deliver = Number(entry.deliver) || 0;
  const ot = Number(entry.ot) || 0;
  const km = Number(entry.km) || 0;
  const soDon = Number(entry.soDon) || 0;

  let luongNgay = 250000;
  let thuong = 0;
  if(soDon >= 25) thuong = 250000;
  else if(soDon >= 20) thuong = 200000;
  else if(soDon >= 10) thuong = 100000;

  let phuCap = deliver*30000 + ot*50000 + km*1000;
  return luongNgay + thuong + phuCap;
}

/* ---------- Helpers ---------- */
function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function resetForm(){
  document.getElementById('date').value = '';
  document.getElementById('donLoai').value = 'Đơn giao';
  document.getElementById('deliver').value = 0;
  document.getElementById('ot').value = 0;
  document.getElementById('km').value = 0;
  document.getElementById('soDon').value = 0;
  document.getElementById('ghiChu').value = '';
}

/* ---------- Add entry ---------- */
function saveEntry(){
  const date = document.getElementById('date').value;
  if(!date){ alert('Hãy chọn ngày!'); return; }

  const entry = {
    date,
    donLoai: document.getElementById('donLoai').value,
    deliver: Number(document.getElementById('deliver').value) || 0,
    ot: Number(document.getElementById('ot').value) || 0,
    km: Number(document.getElementById('km').value) || 0,
    soDon: Number(document.getElementById('soDon').value) || 0,
    ghiChu: (document.getElementById('ghiChu').value || '').trim(),
    createdAt: new Date().toISOString()
  };

  data.push(entry);
  saveData();
  resetForm();
  renderTable();
}

/* ---------- Render table (gộp theo ngày) ---------- */
let chart = null;
function renderTable(){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';

  const filterMonth = document.getElementById('filterMonth').value;
  const q = (document.getElementById('search').value || '').trim().toLowerCase();

  // groups by date
  const groups = {};
  data.forEach((r, idx) => {
    if(filterMonth && !r.date.startsWith(filterMonth)) return;
    if(!groups[r.date]) groups[r.date] = { list: [], totalMoney:0, counts:{} , notes: [] };
    groups[r.date].list.push({ ...r, __idx: idx });
    groups[r.date].totalMoney += calcMoney(r);
    groups[r.date].counts[r.donLoai] = (groups[r.date].counts[r.donLoai] || 0) + 1;
    if(r.ghiChu) groups[r.date].notes.push(r.ghiChu);
  });

  // optional search filter: by date or note
  const rows = Object.keys(groups).sort((a,b)=>b.localeCompare(a)).map(date=>{
    const g = groups[date];
    // if query exists, check date or any note matches
    if(q){
      const inDate = date.includes(q);
      const inNotes = g.notes.join(' ').toLowerCase().includes(q);
      if(!inDate && !inNotes) return null;
    }
    return {date, g};
  }).filter(Boolean);

  // totals for cards
  let tongTien = 0, tongGiao=0, tongBH=0;

  rows.forEach(({date,g})=>{
    tongTien += g.totalMoney;
    tongGiao += g.counts['Đơn giao'] || 0;
    tongBH += g.counts['Đơn bảo hành'] || 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:600">${date}</td>
      <td>${Object.entries(g.counts).map(([k,v])=>`<span class="tag ${k==='Đơn giao'?'tag-giao':'tag-bh'}">${k}</span> ${v}`).join('<br>')}</td>
      <td>${g.list.length}</td>
      <td>${g.totalMoney.toLocaleString()} VND</td>
      <td>${(g.notes.length? g.notes.join(' • ') : '')}</td>
      <td><button class="btn btn-primary" onclick="openModal('${date}')">Chi tiết</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('cardTongTien').innerText = tongTien.toLocaleString() + ' VND';
  document.getElementById('cardGiao').innerText = tongGiao;
  document.getElementById('cardBaoHanh').innerText = tongBH;

  renderChart(rows);
}

/* ---------- Chart ---------- */
function renderChart(rows){
  // rows: array {date, g}
  const labels = rows.map(r=>r.date).reverse();
  // values: total orders and total money (align labels)
  const orders = rows.map(r=>r.g.list.length).reverse();
  const money = rows.map(r=>r.g.totalMoney).reverse();

  const ctx = document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Số đơn',
          data: orders,
          yAxisID: 'y',
          borderRadius: 6,
          barThickness: 14,
        },
        {
          label: 'Tổng tiền (VND)',
          data: money,
          yAxisID: 'y1',
          type: 'line',
          tension: 0.33,
          pointRadius: 4,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {mode:'index', intersect:false},
      scales: {
        x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--muted') } },
        y: { position:'left', title:{display:true,text:'Số đơn'}, ticks:{color: getComputedStyle(document.body).getPropertyValue('--muted')} },
        y1: { position:'right', grid: { drawOnChartArea:false }, title:{display:true,text:'Tổng tiền'}, ticks:{color: getComputedStyle(document.body).getPropertyValue('--muted')},
              callback: function(v){ return v >= 1000 ? v.toLocaleString() : v; } }
      },
      plugins: {legend: { labels:{ color: getComputedStyle(document.body).getPropertyValue('--muted') } }}
    }
  });
}

/* ---------- Modal: show details per date ---------- */
function openModal(date){
  const modal = document.getElementById('modal');
  const listEl = document.getElementById('modalList');
  const modalDate = document.getElementById('modalDate');
  const modalSummary = document.getElementById('modalSummary');

  modalDate.innerText = date;
  listEl.innerHTML = '';

  // get items
  const items = data.map((it, idx)=> ({...it, __idx: idx})).filter(it=>it.date === date);

  let totalMoney = 0;
  items.forEach((r, i)=>{
    totalMoney += calcMoney(r);

    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.justifyContent = 'space-between';
    div.style.padding = '10px';
    div.style.borderBottom = '1px solid rgba(255,255,255,0.03)';

    div.innerHTML = `
      <div style="flex:1;min-width:0">
        <div style="display:flex;gap:10px;align-items:center">
          <div style="font-weight:700">#${r.__idx+1}</div>
          <div class="${r.donLoai === 'Đơn giao' ? 'tag tag-giao' : 'tag tag-bh'}" style="font-weight:700">${r.donLoai}</div>
          <div class="small" style="color:var(--muted)">&nbsp;•&nbsp;Bộ:${r.deliver} OT:${r.ot} KM:${r.km} Đơn:${r.soDon}</div>
        </div>
        <div style="margin-top:6px;color:var(--muted)">${r.ghiChu || '<i style="color:var(--muted)">Không có ghi chú</i>'}</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-left:12px">
        <div style="text-align:right;font-weight:700">${calcMoney(r).toLocaleString()} VND</div>
        <button class="btn btn-ghost" onclick="openEdit(${r.__idx})">Sửa</button>
        <button class="btn btn-ghost" style="color:var(--danger);border-color:rgba(239,68,68,0.12)" onclick="removeEntry(${r.__idx})">Xóa</button>
      </div>
    `;
    listEl.appendChild(div);
  });

  modalSummary.innerText = `Số dòng: ${items.length} • Tổng tiền: ${totalMoney.toLocaleString()} VND`;
  modal.style.display = 'flex';
}

function closeModal(){
  document.getElementById('modal').style.display = 'none';
}

/* ---------- Edit / Remove entry ---------- */
function openEdit(idx){
  // reuse left form to edit — fill values, and set editingIndex
  editingIndex = idx;
  const r = data[idx];
  document.getElementById('date').value = r.date;
  document.getElementById('donLoai').value = r.donLoai;
  document.getElementById('deliver').value = r.deliver;
  document.getElementById('ot').value = r.ot;
  document.getElementById('km').value = r.km;
  document.getElementById('soDon').value = r.soDon;
  document.getElementById('ghiChu').value = r.ghiChu || '';

  // scroll to top so user sees form
  window.scrollTo({top:0,behavior:'smooth'});
}

function removeEntry(idx){
  if(!confirm('Bạn có chắc chắn muốn xóa mục này?')) return;
  data.splice(idx,1);
  saveData();
  renderTable();
  closeModal();
}

/* ---------- When user presses "Lưu" but editingIndex is set -> update ---------- */
document.querySelector('.btn-primary').addEventListener('click', function onPrimaryClick(e){
  // This binds first primary (Lưu) but we handle via saveEntry() directly; override only when editingIndex set
  // We'll not use this generic handler — keep explicit in saveEntry.
});

/* Modified saveEntry to support edit when editingIndex set */
function saveEntry(){
  const date = document.getElementById('date').value;
  if(!date){ alert('Hãy chọn ngày!'); return; }

  const entry = {
    date,
    donLoai: document.getElementById('donLoai').value,
    deliver: Number(document.getElementById('deliver').value) || 0,
    ot: Number(document.getElementById('ot').value) || 0,
    km: Number(document.getElementById('km').value) || 0,
    soDon: Number(document.getElementById('soDon').value) || 0,
    ghiChu: (document.getElementById('ghiChu').value || '').trim(),
    createdAt: new Date().toISOString()
  };

  if(editingIndex !== null){
    // update existing
    data[editingIndex] = entry;
    editingIndex = null;
  } else {
    data.push(entry);
  }

  saveData();
  resetForm();
  renderTable();
}

/* ---------- Export CSV ---------- */
function exportCSV(){
  if(!data.length){ alert('Không có dữ liệu để xuất'); return; }
  let csv = 'Ngày,Loại,Deliver,OT,KM,Số đơn,Ghi chú,Tổng tiền\n';
  data.forEach(r=>{
    const line = [
      r.date,
      r.donLoai,
      r.deliver,
      r.ot,
      r.km,
      r.soDon,
      '"' + (r.ghiChu || '').replace(/"/g, '""') + '"',
      calcMoney(r)
    ];
    csv += line.join(',') + '\n';
  });
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ChamLuong_export_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

/* ---------- Clear all ---------- */
function clearAll(){
  if(!confirm('Xóa toàn bộ dữ liệu trong localStorage? Hành động này không thể hoàn tác.')) return;
  localStorage.removeItem(STORAGE_KEY);
  data = [];
  editingIndex = null;
  renderTable();
}

/* ---------- Initialization ---------- */
renderTable();
</script>

</body>
</html>
